{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "particle-wave-shaper",
  "description": "Wave shaper",
  "registryDependencies": [
    "@audio/use-audio",
    "@audio/fader",
    "@audio/xypad",
    "@audio/knob",
    "@shadcn/toggle-group"
  ],
  "files": [
    {
      "path": "src/registry/default/particles/particle-wave-shaper.tsx",
      "content": "\"use client\";\n\nimport * as React from \"react\";\nimport { useAudio } from \"@/registry/default/hooks/use-audio\";\nimport { Fader } from \"@/registry/default/ui/audio/elements/fader\";\nimport { Knob } from \"@/registry/default/ui/audio/elements/knob\";\nimport { XYPad } from \"@/registry/default/ui/audio/elements/xypad\";\nimport {\n  ToggleGroup,\n  ToggleGroupItem,\n} from \"@/registry/default/ui/toggle-group\";\n\ntype WaveformType = \"sine\" | \"triangle\" | \"sawtooth\" | \"square\";\n\nexport default function ParticleWaveShaper() {\n  const { webAudio } = useAudio();\n  const [waveform, setWaveform] = React.useState<WaveformType>(\"sine\");\n  const [volume, setVolume] = React.useState(0.5);\n  const [drive, setDrive] = React.useState(1);\n  const [tone, setTone] = React.useState(50);\n  const [detune, setDetune] = React.useState(0);\n  const [mix, setMix] = React.useState(50);\n  const [isPlaying, setIsPlaying] = React.useState(false);\n  const [position, setPosition] = React.useState({ x: 0.5, y: 0.5 });\n\n  const oscillator1Ref = React.useRef<OscillatorNode | null>(null);\n  const oscillator2Ref = React.useRef<OscillatorNode | null>(null);\n  const gainNodeRef = React.useRef<GainNode | null>(null);\n  const dryGainRef = React.useRef<GainNode | null>(null);\n  const wetGainRef = React.useRef<GainNode | null>(null);\n  const shaperRef = React.useRef<WaveShaperNode | null>(null);\n  const filterRef = React.useRef<BiquadFilterNode | null>(null);\n\n  const getFrequency = React.useCallback((x: number) => {\n    const minFreq = 55;\n    const maxFreq = 880;\n    return minFreq * (maxFreq / minFreq) ** x;\n  }, []);\n\n  const getResonance = React.useCallback((y: number) => 0.5 + y * 15, []);\n\n  const makeDistortionCurve = React.useCallback((amount: number) => {\n    const samples = 44_100;\n    const curve = new Float32Array(samples);\n    const deg = Math.PI / 180;\n\n    for (let i = 0; i < samples; i++) {\n      const x = (i * 2) / samples - 1;\n      curve[i] =\n        ((3 + amount) * x * 20 * deg) / (Math.PI + amount * Math.abs(x));\n    }\n\n    return curve;\n  }, []);\n\n  const startSound = React.useCallback(\n    (x: number, y: number) => {\n      const ctx = webAudio.getContext();\n      if (!ctx) {\n        return;\n      }\n\n      const now = ctx.currentTime;\n      const frequency = getFrequency(x);\n      const resonance = getResonance(y);\n\n      const osc1 = ctx.createOscillator();\n      const osc2 = ctx.createOscillator();\n      osc1.type = waveform;\n      osc2.type = waveform;\n      osc1.frequency.setValueAtTime(frequency, now);\n      osc2.frequency.setValueAtTime(frequency, now);\n      osc2.detune.setValueAtTime(detune, now);\n\n      const oscGain = ctx.createGain();\n      const dryGain = ctx.createGain();\n      const wetGain = ctx.createGain();\n      const mainGain = ctx.createGain();\n\n      const shaper = ctx.createWaveShaper();\n      shaper.curve = makeDistortionCurve(drive);\n      shaper.oversample = \"4x\";\n\n      const filter = ctx.createBiquadFilter();\n      filter.type = \"lowpass\";\n      filter.frequency.setValueAtTime(500 + tone * 75, now);\n      filter.Q.setValueAtTime(resonance, now);\n\n      const dryLevel = (100 - mix) / 100;\n      const wetLevel = mix / 100;\n\n      oscGain.gain.setValueAtTime(0.5, now);\n      dryGain.gain.setValueAtTime(dryLevel, now);\n      wetGain.gain.setValueAtTime(wetLevel, now);\n      mainGain.gain.setValueAtTime(0, now);\n      mainGain.gain.linearRampToValueAtTime(volume * 0.4, now + 0.02);\n\n      osc1.connect(oscGain);\n      osc2.connect(oscGain);\n\n      oscGain.connect(dryGain);\n\n      oscGain.connect(shaper);\n      shaper.connect(wetGain);\n\n      dryGain.connect(filter);\n      wetGain.connect(filter);\n      filter.connect(mainGain);\n      mainGain.connect(ctx.destination);\n\n      osc1.start();\n      osc2.start();\n\n      oscillator1Ref.current = osc1;\n      oscillator2Ref.current = osc2;\n      gainNodeRef.current = mainGain;\n      dryGainRef.current = dryGain;\n      wetGainRef.current = wetGain;\n      shaperRef.current = shaper;\n      filterRef.current = filter;\n      setIsPlaying(true);\n    },\n    [\n      detune,\n      drive,\n      getFrequency,\n      getResonance,\n      makeDistortionCurve,\n      mix,\n      tone,\n      volume,\n      waveform,\n      webAudio,\n    ]\n  );\n\n  const stopSound = React.useCallback(() => {\n    const ctx = webAudio.getContext();\n    if (\n      !(\n        ctx &&\n        gainNodeRef.current &&\n        oscillator1Ref.current &&\n        oscillator2Ref.current\n      )\n    ) {\n      return;\n    }\n\n    const now = ctx.currentTime;\n    gainNodeRef.current.gain.linearRampToValueAtTime(0, now + 0.05);\n\n    const osc1 = oscillator1Ref.current;\n    const osc2 = oscillator2Ref.current;\n\n    setTimeout(() => {\n      osc1.stop();\n      osc1.disconnect();\n      osc2.stop();\n      osc2.disconnect();\n    }, 60);\n\n    oscillator1Ref.current = null;\n    oscillator2Ref.current = null;\n    gainNodeRef.current = null;\n    dryGainRef.current = null;\n    wetGainRef.current = null;\n    shaperRef.current = null;\n    filterRef.current = null;\n    setIsPlaying(false);\n  }, [webAudio]);\n\n  const updateSound = React.useCallback(\n    (x: number, y: number) => {\n      const ctx = webAudio.getContext();\n      if (\n        !(\n          ctx &&\n          oscillator1Ref.current &&\n          oscillator2Ref.current &&\n          filterRef.current\n        )\n      ) {\n        return;\n      }\n\n      const now = ctx.currentTime;\n      const frequency = getFrequency(x);\n      const resonance = getResonance(y);\n\n      oscillator1Ref.current.frequency.setTargetAtTime(frequency, now, 0.01);\n      oscillator2Ref.current.frequency.setTargetAtTime(frequency, now, 0.01);\n      filterRef.current.Q.setTargetAtTime(resonance, now, 0.01);\n    },\n    [getFrequency, getResonance, webAudio]\n  );\n\n  React.useEffect(() => {\n    if (oscillator1Ref.current && oscillator2Ref.current) {\n      oscillator1Ref.current.type = waveform;\n      oscillator2Ref.current.type = waveform;\n    }\n  }, [waveform]);\n\n  React.useEffect(() => {\n    const ctx = webAudio.getContext();\n    if (oscillator2Ref.current && ctx) {\n      oscillator2Ref.current.detune.setTargetAtTime(\n        detune,\n        ctx.currentTime,\n        0.01\n      );\n    }\n  }, [detune, webAudio]);\n\n  React.useEffect(() => {\n    if (shaperRef.current) {\n      shaperRef.current.curve = makeDistortionCurve(drive);\n    }\n  }, [drive, makeDistortionCurve]);\n\n  React.useEffect(() => {\n    const ctx = webAudio.getContext();\n    if (filterRef.current && ctx) {\n      const now = ctx.currentTime;\n      filterRef.current.frequency.setTargetAtTime(500 + tone * 75, now, 0.01);\n    }\n  }, [tone, webAudio]);\n\n  React.useEffect(() => {\n    const ctx = webAudio.getContext();\n    if (dryGainRef.current && wetGainRef.current && ctx) {\n      const now = ctx.currentTime;\n      const dryLevel = (100 - mix) / 100;\n      const wetLevel = mix / 100;\n      dryGainRef.current.gain.setTargetAtTime(dryLevel, now, 0.01);\n      wetGainRef.current.gain.setTargetAtTime(wetLevel, now, 0.01);\n    }\n  }, [mix, webAudio]);\n\n  React.useEffect(() => {\n    const ctx = webAudio.getContext();\n    if (gainNodeRef.current && ctx) {\n      gainNodeRef.current.gain.setTargetAtTime(\n        volume * 0.4,\n        ctx.currentTime,\n        0.01\n      );\n    }\n  }, [volume, webAudio]);\n\n  React.useEffect(\n    () => () => {\n      if (oscillator1Ref.current) {\n        oscillator1Ref.current.stop();\n        oscillator1Ref.current.disconnect();\n      }\n      if (oscillator2Ref.current) {\n        oscillator2Ref.current.stop();\n        oscillator2Ref.current.disconnect();\n      }\n    },\n    []\n  );\n\n  const formatValue = React.useCallback(\n    (val: { x: number; y: number }) => {\n      const x = val.x / 100;\n      const y = val.y / 100;\n      const freq = Math.round(getFrequency(x));\n      const res = getResonance(y).toFixed(1);\n      return (\n        <>\n          <span>{freq}Hz</span>\n          <span>, Q: {res}</span>\n        </>\n      );\n    },\n    [getFrequency, getResonance]\n  );\n\n  const waveformOptions: {\n    icon: React.ReactNode;\n    label: string;\n    value: WaveformType;\n  }[] = [\n    {\n      icon: (\n        <svg\n          className=\"h-5 w-5\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          strokeWidth=\"2\"\n          viewBox=\"0 0 24 24\"\n        >\n          <title>Sine wave</title>\n          <path d=\"M2 12c2-4 4-4 6 0s4 4 6 0 4-4 6 0 4 4 6 0\" />\n        </svg>\n      ),\n      label: \"Sine wave\",\n      value: \"sine\",\n    },\n    {\n      icon: (\n        <svg\n          className=\"h-5 w-5\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          strokeWidth=\"2\"\n          viewBox=\"0 0 24 24\"\n        >\n          <title>Triangle wave</title>\n          <path d=\"M2 12l5-6 5 12 5-12 5 6\" />\n        </svg>\n      ),\n      label: \"Triangle wave\",\n      value: \"triangle\",\n    },\n    {\n      icon: (\n        <svg\n          className=\"h-5 w-5\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          strokeWidth=\"2\"\n          viewBox=\"0 0 24 24\"\n        >\n          <title>Sawtooth wave</title>\n          <path d=\"M2 18l8-12v12l8-12v12\" />\n        </svg>\n      ),\n      label: \"Sawtooth wave\",\n      value: \"sawtooth\",\n    },\n    {\n      icon: (\n        <svg\n          className=\"h-5 w-5\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          strokeWidth=\"2\"\n          viewBox=\"0 0 24 24\"\n        >\n          <title>Square wave</title>\n          <path d=\"M2 18h4V6h6v12h4V6h6\" />\n        </svg>\n      ),\n      label: \"Square wave\",\n      value: \"square\",\n    },\n  ];\n\n  return (\n    <div className=\"flex w-full min-w-0 flex-col gap-1.5 rounded-xl border bg-card p-1.5\">\n      <XYPad\n        formatValue={formatValue}\n        maxX={100}\n        maxY={100}\n        minX={0}\n        minY={0}\n        onValueChange={(val) => {\n          const normalizedX = val.x / 100;\n          const normalizedY = val.y / 100;\n          setPosition({ x: normalizedX, y: normalizedY });\n          if (isPlaying) {\n            updateSound(normalizedX, normalizedY);\n          } else {\n            startSound(normalizedX, normalizedY);\n          }\n        }}\n        onValueCommit={() => {\n          stopSound();\n        }}\n        value={{ x: position.x * 100, y: position.y * 100 }}\n      />\n      <ToggleGroup\n        className=\"w-full\"\n        onValueChange={(value) => {\n          if (value) {\n            setWaveform(value as WaveformType);\n          }\n        }}\n        size=\"sm\"\n        type=\"single\"\n        value={waveform}\n        variant=\"outline\"\n      >\n        {waveformOptions.map(({ icon, label, value }) => (\n          <ToggleGroupItem\n            aria-label={label}\n            className=\"flex-1\"\n            key={value}\n            value={value}\n          >\n            {icon}\n          </ToggleGroupItem>\n        ))}\n      </ToggleGroup>\n      <div className=\"grid grid-cols-4 gap-3 rounded-lg border bg-popover p-1.5\">\n        <div className=\"flex flex-col items-center gap-1.5\">\n          <label\n            className=\"font-medium text-muted-foreground text-xs\"\n            htmlFor=\"drive\"\n          >\n            Drive\n          </label>\n          <Knob\n            defaultValue={1}\n            id=\"drive\"\n            max={100}\n            min={0}\n            onValueChange={setDrive}\n            size=\"sm\"\n            step={1}\n          />\n          <output className=\"font-mono text-muted-foreground text-xs\">\n            {drive}\n          </output>\n        </div>\n        <div className=\"flex flex-col items-center gap-1.5\">\n          <label\n            className=\"font-medium text-muted-foreground text-xs\"\n            htmlFor=\"tone\"\n          >\n            Tone\n          </label>\n          <Knob\n            defaultValue={50}\n            id=\"tone\"\n            max={100}\n            min={0}\n            onValueChange={setTone}\n            size=\"sm\"\n            step={1}\n          />\n          <output className=\"font-mono text-muted-foreground text-xs\">\n            {tone}\n          </output>\n        </div>\n\n        <div className=\"flex flex-col items-center gap-1.5\">\n          <label\n            className=\"font-medium text-muted-foreground text-xs\"\n            htmlFor=\"detune\"\n          >\n            Detune\n          </label>\n          <Knob\n            defaultValue={0}\n            id=\"detune\"\n            max={50}\n            min={-50}\n            onValueChange={setDetune}\n            size=\"sm\"\n            step={1}\n          />\n          <output className=\"font-mono text-muted-foreground text-xs\">\n            {detune > 0 ? \"+\" : \"\"}\n            {detune}\n          </output>\n        </div>\n\n        <div className=\"flex flex-col items-center gap-1.5\">\n          <label\n            className=\"font-medium text-muted-foreground text-xs\"\n            htmlFor=\"mix\"\n          >\n            Mix\n          </label>\n          <Knob\n            defaultValue={50}\n            id=\"mix\"\n            max={100}\n            min={0}\n            onValueChange={setMix}\n            size=\"sm\"\n            step={1}\n          />\n          <output className=\"font-mono text-muted-foreground text-xs\">\n            {mix}%\n          </output>\n        </div>\n      </div>\n\n      <div className=\"flex items-center gap-3 rounded-lg border bg-popover p-3\">\n        <label\n          className=\"font-medium text-muted-foreground text-sm leading-tight\"\n          htmlFor=\"volume\"\n        >\n          Volume\n        </label>\n        <Fader\n          className=\"mx-1.5 flex-1\"\n          id=\"volume\"\n          max={1}\n          min={0}\n          onValueChange={setVolume}\n          orientation=\"horizontal\"\n          step={0.01}\n          value={volume}\n        />\n        <output className=\"font-mono text-muted-foreground text-sm\">\n          {Math.round(volume * 100)}%\n        </output>\n      </div>\n    </div>\n  );\n}\n",
      "type": "registry:block",
      "target": "components/audio/particles/particle-wave-shaper.tsx"
    }
  ],
  "categories": [
    "synth"
  ],
  "type": "registry:block"
}